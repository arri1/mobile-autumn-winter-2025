# Инструкция по тестированию созвона (WebRTC)

## Текущее состояние

На данный момент реализована базовая инфраструктура для WebRTC:
- ✅ Получение конфигурации STUN/TURN серверов с бэкенда
- ✅ Экран звонка с базовым UI
- ✅ Навигация к экрану звонка из списка пользователей
- ⚠️ Полноценный видеозвонок еще не реализован (требуется установка react-native-webrtc)

## Как протестировать текущую функциональность

### 1. Тестирование базовой навигации и получения конфигурации

#### Шаг 1: Запустите приложение
```bash
npm start
# или
expo start
```

#### Шаг 2: Войдите в систему
- Используйте существующий аккаунт или создайте новый

#### Шаг 3: Откройте список пользователей
- Перейдите на вкладку "Пользователи" в нижней навигации
- Убедитесь, что видите список других пользователей

#### Шаг 4: Инициируйте звонок
- Нажмите на кнопку с иконкой телефона рядом с любым пользователем
- Должен открыться экран звонка с информацией о пользователе

#### Шаг 5: Проверьте получение конфигурации
На экране звонка вы должны увидеть:
- ✅ Статус "Готов к звонку" (после загрузки)
- ✅ Информацию о конфигурации WebRTC:
  - Количество STUN серверов
  - Количество TURN серверов
  - Общее количество ICE серверов

### 2. Тестирование на нескольких устройствах

#### Вариант 1: Два физических устройства
1. Запустите приложение на первом устройстве
2. Запустите приложение на втором устройстве (или эмуляторе)
3. Войдите под разными пользователями
4. На первом устройстве найдите второго пользователя и нажмите кнопку звонка
5. Проверьте, что экран звонка открывается корректно

#### Вариант 2: Эмулятор + физическое устройство
1. Запустите приложение в эмуляторе Android/iOS
2. Запустите приложение на физическом устройстве
3. Используйте разные аккаунты
4. Протестируйте навигацию к экрану звонка

### 3. Проверка API эндпоинта напрямую

Вы можете проверить, что бэкенд возвращает конфигурацию ICE серверов:

```bash
# Получите токен авторизации (из приложения или через логин)
TOKEN="your_access_token_here"

# Запрос к API
curl -X GET http://localhost:3000/api/webrtc/ice-servers \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json"
```

Ожидаемый ответ:
```json
{
  "success": true,
  "data": {
    "iceServers": [
      {
        "urls": "stun:stun.l.google.com:19302"
      },
      {
        "urls": "stun:stun1.l.google.com:19302"
      },
      {
        "urls": ["turn:openrelay.metered.ca:80"],
        "username": "openrelayproject",
        "credential": "openrelayproject"
      }
    ]
  }
}
```

### 4. Проверка через DevTools/Console

Откройте консоль разработчика (React Native Debugger или в браузере при использовании Expo):
- Проверьте логи при открытии экрана звонка
- Должны быть сообщения о получении конфигурации ICE серверов
- Проверьте отсутствие ошибок сети

## Что можно протестировать сейчас

✅ **Работает:**
- Навигация к экрану звонка
- Получение конфигурации STUN/TURN серверов с бэкенда
- Отображение информации о пользователе
- Отображение статуса и конфигурации WebRTC
- Очистка ресурсов при закрытии экрана

⚠️ **Не реализовано (требуется для полноценного видеозвонка):**
- Установка `react-native-webrtc` или использование WebRTC в Expo
- Создание медиа-потоков (видео/аудио)
- Установка peer-to-peer соединения
- Обмен SDP offer/answer через WebSocket
- Обмен ICE candidates
- Отображение видео потоков

## Для полноценного тестирования видеозвонка

Чтобы протестировать полноценный видеозвонок, необходимо:

1. **Установить react-native-webrtc** (для bare React Native):
```bash
npm install react-native-webrtc
# или для Expo использовать expo-av (ограниченная функциональность)
```

2. **Настроить WebSocket сервер** для сигналинга (обмен SDP и ICE candidates)

3. **Реализовать медиа-потоки**:
   - Запрос разрешений на камеру/микрофон
   - Создание локального потока
   - Отображение локального и удаленного видео

4. **Реализовать WebRTC соединение**:
   - Создание RTCPeerConnection
   - Обмен SDP offer/answer
   - Обмен ICE candidates
   - Обработка событий соединения

## Чек-лист для тестирования

- [ ] Приложение запускается без ошибок
- [ ] Можно войти в систему
- [ ] Виден список пользователей
- [ ] Кнопка звонка отображается рядом с пользователями
- [ ] При нажатии на кнопку звонка открывается экран CallScreen
- [ ] На экране звонка отображается информация о пользователе
- [ ] Конфигурация ICE серверов успешно загружается
- [ ] Отображается информация о количестве STUN/TURN серверов
- [ ] При нажатии "Завершить звонок" экран закрывается
- [ ] Нет ошибок в консоли при открытии/закрытии экрана звонка

## Возможные проблемы и решения

### Проблема: "Не удалось инициализировать WebRTC"
**Решение:** 
- Проверьте подключение к интернету
- Убедитесь, что бэкенд запущен и доступен
- Проверьте, что токен авторизации валиден

### Проблема: Конфигурация не загружается
**Решение:**
- Проверьте URL бэкенда в `src/services/api.js`
- Проверьте, что эндпоинт `/api/webrtc/ice-servers` доступен
- Проверьте токен авторизации

### Проблема: Не видно других пользователей
**Решение:**
- Убедитесь, что в системе есть несколько пользователей
- Проверьте права доступа (для обычных пользователей список может быть ограничен)
- Попробуйте создать второго пользователя через регистрацию

## Дополнительные ресурсы

- [WebRTC документация](https://webrtc.org/)
- [react-native-webrtc](https://github.com/react-native-webrtc/react-native-webrtc)
- [Expo AV для аудио](https://docs.expo.dev/versions/latest/sdk/av/)

